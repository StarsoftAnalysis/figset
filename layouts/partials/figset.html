{{/*
  figset partial, version of figure with srcsetting.

  This is figset -- copied from figset 27/4/20, for use with hacked lightbox2:
   - no wrapping <a> -- add the data-lightbox etc. to the <fig> 

  TODO:
  * NEXT: don't do flex if no ROW! OR do use a flex div to do the l/r/center!? -- would need another div that the figrow didn't provide.
  * FIXME: small images (thumbnails) are still small in carousel  (Can't reproduce that now)
  * more size options, e.g. 50% (width), 6em, bs4 class... -- but how to scale those for area?
  * lazy loading -- see https://developer.mozilla.org/en-US/docs/Web/Performance/Lazy_loading
  * margin:0 for figures -- check that this is OK in all cases. - maybe only in figrow
  * get rid of bootstrap or use it properly -- via external CSS
  * decouple from lightboxSSA to allow use of other lightboxes??
  * selfsize to limit size of expanded image, e.g. if not in a gallery
  * url/link -- option e.g. url=self to link to selfsize version of same image
    - rename url to link?
  * fix 'null' when hovering over image in carousel
  * height is fixed no. of pixels, i.e. not responsive, which is rubbish.  at the moment can use width=nnpx to make
    the caption fit the width of the picture.
  * try height with vw units...
  * fitting caption to responsive image width! -- may need JS!!  see this: https://codepen.io/starsoftanalysis/pen/QWrqyGQ
  * need left/center/right options for captions -- in figset  and margin:0 auto for image if centred

  DONE:
  * if image not found, create a placeholder with various assumptions, e.g. it's square. i.e. use a placeholder image in static or wherever
  * use flex-grow and -shrink ??  NO -- see https://codepen.io/starsoftanalysis/pen/Rwyppdv
  * FIRST: decide how multiple figsets should behave if not within a figrow. -- maybe don't try too hard -- encourage use of figrow.
     - e.g. poses l, c, r  pushes third one to next line.
  * move error handling to shortcodes? -- see https://gohugo.io/templates/shortcode-templates/#error-handling-in-shortcodes
  * NO: could do a percentage if we knew how many are in the row (can the parent tell us?)

  This can be used from another template, with args passed in as a dict, e.g.
    {{- partial "figset.html" (dict "page" . "name" "thingy.jpg" "size" "medium" "#01589B" "width" 10 "height" 20 ) -}}
  or via the corresponding shortcode:
    {{< figset name="fred.png" size="medium" >}}

  The figset shortcode can get all options from a figrow parent (if any).

  args (in the dict/context):
    .page -- current page
    .figrow -- true if we're within a figrow (which is independent of whether there's a gallery)
    .name (of image within the page bundle)
    .image (resource) or name (name of image file in bundle) -- image overrides name
    .position - left/start, right/end, centre/center
    .size - thumb, small, medium, large, full  TODO other sizes  FIXME hook into bootstrap sizing
    .maxwidth -- biggest size used for srcset in pixels, or for url=self
    .selfsize -- max size in px of url=self image
    .title
    .caption
    .alt
    .url -- url to link to -- on second click if galleried, or 'self'
    .gallery - name of gallery -- just has to be the same on a group of figures to make them a gallery - implies lightbox
    .lightbox - anything truthy to add lightbox effect without making it a gallery
    .height -- only px units so far. 
        -- ?units -- maybe need responsive values.  Overrides size, for use (e.g. from figrow) to make a row of images line up.
        -- allow: px  em  % .... ...  remember at this stage we have no idea of screen size or shape
            -- if %, can calculate width as % (of container) and then estimate sizes as vw -- or maybe just specify sizes as vh
            -- if px, calculate width as px, then need to do media things for sizes, copying transitions from those used for bootstrap
            -- if em, depends on font size, so maybe don't handle that.  Or assume 16px


*/}}

{{/* Parameters and defaults. */}}
{{- $figrow := .figrow | default false -}}
{{- $name   := .name   | default "" -}}

{{/* Image can be specified as .image or .name -- .image takes precedence */}}
{{- $image := "" -}}
{{- if isset . "image" -}}
  {{- $image = .image -}}
{{- else -}}
  {{- $image = .page.Resources.GetMatch $name -}}
{{- end -}}
{{ if not $image }}
  {{ $image = resources.GetMatch "images/placeholder.png" }}{{/* FIXME looks in assets/images/ */}}
{{ end }}

{{/* carry on with parameters and defaults */}}
{{- $position := lower .position | default "left" -}}
{{- $size := lower .size | default "medium" -}}
{{- $selfsize := (int (.selfsize | default 2000)) -}}
{{- $maxwidth := (int (.maxwidth | default 2000)) -}}
{{- $title := .title | default "" }}
{{- $caption := .caption | default "" -}}
{{- $url := .url | default "" -}}  {{/* $image.Params.Url | default "" -}}{{/* FIXME is this right? will make the link go to the orig image? Need to test if $image is set */}}
{{- $alt := .alt | default $title -}}
{{- $gallery := .gallery | default "" }}
{{- $lightbox := .lightbox | default false -}}
{{- $height := lower .height | default "" -}}{{/* string may have units e.g. 100px */}}

{{/* Some things only apply within a figrow (and vice versa) */}}
{{ if $figrow }}
{{ else }}
{{ end }}

{{/* TEMP diagnostics: */}}
{{/* $caption = printf "i=%v p=%s s=%s t=%s c=%s u=%s a=%s g=%s l=%v h=%v fr=%t" $image $position $size $title $caption $url $alt $gallery $lightbox $height $figrow */}}

{{/* warnf "\nfigset: .page=%s  name=%s image=%v\n" .page.Page $name $image */}}
{{/* There should always be an image (see placeholder above) so just return if not */}}

{{- if $image -}}
  {{- $origwidth := $image.Width -}}
  {{- $origheight := $image.Height -}}
  {{- $aspect := div (float $origwidth) (float $origheight) -}}
  {{- $origsize := int (math.Max $origwidth $origheight) -}}
  {{- if gt $maxwidth $origwidth -}}{{- $maxwidth = $origwidth -}}{{- end -}}
  {{/* Just a big list, in descending order (so that default size is first, and so that JS (i.e. lightboxSSA) can handle the list easily) */}} {{/* REMOVE -- it's in _imagesize */}}
  {{- $allwidths := slice 1800 1600 1400 1200 1000 800 600 400 200 -}}{{/* REMOVE -- it's in _imagesize */}}
  {{/* warnf "fs: origw,h=%d,%d aspect=%.2f origsize=%d ssize=%d maxwidth=%d\n" $origwidth $origheight $aspect $origsize $selfsize $maxwidth */}}

  {{- $heightval := 0 -}}
  {{- $heightunit := "" -}}
  {{- $imagelist := slice -}}{{/* empty slice */}}
  {{- $imagewidth := 0 -}}
  {{- $imagewidthstring := "" -}}
  {{- $imagemargincss := "" -}}
  {{- $posclass := "" -}}
  {{- $sizes := "" -}}
  
  {{- $sizeString := "" -}}

  {{- if eq (lower $url) "self" -}}
    {{/* Link to the image itself -- but limited by selfsize */}}
    {{/* FIXME do we need to do the whole srcset thing for the linked image? NO *
    {{- $imagedetails := partial "figset_imagesize.html" (dict "image" $image "size" $selfsize "aspect" $aspect "maxwidth" $maxwidth) -}}
    {{ warnf "imagedetails: %+v" $imagedetails }}
    {{- $linkedimage := index $imagedetails.imagelist 0 -}}
    {{- $url = $linkedimage.RelPermalink -}}
    {{ warnf "linked=%+#v url=%s" $linkedimage $url }}
    */}}
    {{- $linkedimage := $image -}}
    {{- if gt $origsize $selfsize -}}
      {{- if eq $origsize $origwidth -}}
        {{- $linkedimage = $image.Resize (printf "%dx jpg" $selfsize) -}}
      {{- else -}}
        {{- $linkedimage = $image.Resize (printf "x%d jpg" $selfsize) -}}
      {{- end -}}
    {{- end -}}
    {{- $url = $linkedimage.RelPermalink -}}
  {{- end -}}

  {{/* Position is ignored within a figrow */}}
  {{ if $figrow }}
    {{ if $position }}
      {{ warnf "figset: position ignored within figrow for image %v" $image }}
    {{- end -}}
  {{ else }}
    {{/* position: left/start | right/end | centre/center -- can be abbreviated. */}}
    {{- if or (hasPrefix "left" $position) (hasPrefix "start" $position) -}}
      {{/* need e.g. text-right for figure, float-right for img NO! */}}
      {{- $posclass = "float-start mr-3" -}}
    {{- else if or (hasPrefix "right" $position) (hasPrefix "end" $position) -}}
      {{- $posclass = "float-end ml-3" -}}
    {{- else if or (hasPrefix "centre" $position) (hasPrefix "center" $position) -}}
      {{/* FIXME? use text-center in enclosing div instead of "m-auto d-block" to center img */}}
      {{- $posclass = "mx-auto d-block" -}}
    {{- else -}}
      {{- warnf "figset: invalid position '%s' for image %v -- using 'centre'" $position $image -}}
      {{- $posclass = "mx-auto d-block" -}}
    {{- end -}}
  {{- end -}}

  {{/* height overrides size */}}
  {{/* height-limited row needs a lot of work -- e.g. non-px suffixes */}}

  {{- if $height -}}

    {{/* We can only handle pixels as units -- either "123px" or "123" */}}
    {{- $heightunit = "px" -}}{{/* default if no (or unknown) units */}}
    {{- if strings.HasSuffix $height "px" -}}
      {{- $heightval = int (strings.TrimSuffix "px" $height) -}}
    {{/* $heightunit is never used!
    {{- else if strings.HasSuffix $height "vh" -}}
      {{- $heightval = int (strings.TrimSuffix "vh" $height) -}}
      {{- $heightunit = "vh" -}}
    */}}
    {{- else -}}
      {{- $heightval = int $height -}}{{/* FIXME this will give an error with any unknown suffix */}}
    {{- end -}}
    {{- $imagewidth = (mul $heightval $aspect) -}}
    {{- $imagewidthstring = (printf "width: %dpx;" (int $imagewidth)) -}}
    {{- if gt $heightval $origheight -}}
      {{/* don't want to expand image, so give it a top/bottom margin */}}
      {{- $imagemargincss = printf "margin: %fpx 0; border: 1px solid red;" (div (sub $heightval $origheight) 2.0) -}}
      {{- $imagelist = $imagelist | append $image -}}
    {{- else -}}
      {{/* resize to the exact size required */}}
      {{/* See [image] section of config.toml for image processing options */}}
      {{- $imagelist = $imagelist | append ($image.Resize (printf "x%d jpg" (int $heightval))) -}}
    {{- end -}}
    {{/* warnf "fs(h): heightval=%v hunit=%s imagewidth=%v imagelist=%v iwidth=%v iwstring=%v imcss=%v posclass=%v sizes=%v\n" $heightval $heightunit $imagewidth $imagelist $imagewidth $imagewidthstring $imagemargincss $posclass $sizes */}}
    {{- if $size -}}
      {{- warnf "figset: size ignored when height given for image '%v'" $image -}}
    {{- end -}}

  {{- else -}}{{/* starting with size/width, so more complicated... */}}

    {{/* TODO need this for selfsize too, so make it a function, ie a partial that returns stuff */}}
    {{/* 
      Image sizes are : thumbnail  small  medium  large  full -- any abbreviation is enough. 
      Based on a 'typical' 1.4:1 image, these fit across screen sizes 
      as defined in the $idealWXxx slices below (in vw aka % units)
      (bearing in mind that the available width is not the whole screen width)
      
      The area A of each ideal image in term of aspect ratio (w/h) R is width*height or width-squared/R

      Each real image, with aspect ratio R', should have the same area, so its height is sqrt(A/R')
      and its width is its height*R'
    */}}
    {{/*       screen width:  1200+ 992+ 768+ 576+ else */}}
    {{ $idealWThumb  := slice   10   12   15   25   45 }}
    {{ $idealWSmall  := slice   25   25   30   45  100 }}
    {{ $idealWMedium := slice   33   40   50   80  100 }}
    {{ $idealWLarge  := slice   50   60   80  100  100 }}
    {{ $idealWFull   := slice  100  100  100  100  100 }}

    {{ $idealW := $idealWMedium }}{{/* used if none of the strings match */}}
    {{ if hasPrefix $size "t" }}
      {{ $idealW = $idealWThumb }}
    {{ else if hasPrefix $size "s" }}
      {{ $idealW = $idealWSmall }}
    {{ else if hasPrefix $size "m" }}
      {{ $idealW = $idealWMedium }}
    {{ else if hasPrefix $size "l" }}
      {{ $idealW = $idealWLarge }}
    {{ else if hasPrefix $size "f" }}
      {{ $idealW = $idealWFull }}
    {{ else }}
      {{ warnf "figset: invalid value for size '%s' -- using 'medium' instead." $size }}
    {{ end }}
    {{/* warnf ">>> $size='%s'  equaltothumb = %v\n" $size (eq $size "thumb") */}}

    {{/* now only one set of calcs required */}}
    {{ $idealAspect  := 1.4 }}
    {{ $areas := slice }}
    {{ $widths := slice }}
    {{ range $w := $idealW }}
      {{ $areas = $areas | append (int (math.Round (div (mul $w $w) $idealAspect))) }}
      {{ $area := int (math.Round (div (mul $w $w) $idealAspect)) }}
      {{ $y := math.Sqrt (div $area $aspect) }}
      {{/* warnf "fs:  image=%v  area=%v y=%v $aspect=%v pya=%v mrm=%v m100m=%v inthat=%v\n" $image $area $y $aspect (mul $y $aspect)  (math.Round (mul $y $aspect)) (math.Min 100 (math.Round (mul $y $aspect)))  (int (math.Min 100 (math.Round (mul $y $aspect)))) */}}
      {{ $widths = $widths | append (int (math.Min 100 (math.Round (mul $y $aspect)))) }}
    {{ end }}
    {{/* warnf "fs:  image=%v .size=%v $size=%v idealW=%v  areas=%v  widths=%v\n" $image .size $size $idealW $areas $widths */}}

    {{ $sizeString = printf "(min-width: 1200px) %dvw, (min-width: 992px) %dvw, (min-width: 768px) %dvw, (min-width: 576px) %dvw, %dvw" (index $widths 0) (index $widths 1) (index $widths 2) (index $widths 3) (index $widths 4) }}
    {{/* warnf "sizeString=%s\n" $sizeString */}} 

    <!-- <p>{{ $allwidths }} max {{ $maxwidth }} orig {{ $origwidth }} -->
    {{- range $w := $allwidths -}}
      {{- if le $w $maxwidth -}}
        {{- $imagelist = $imagelist | append ($image.Resize (printf "%dx jpg" $w)) -}}
      {{- end -}}
    {{- end -}}
    {{- if eq (len $imagelist) 0 -}}
      {{- $imagelist = $imagelist | append $image -}}
    {{- end -}}

  {{- end -}}{{/* else, not $height */}}

  {{/* warnf "fs: title=%s h=%v iw=%v aspect=%.2f iw/aspect=%.2f area=%v imcss=%s\n" $title .height (int $imagewidth) $aspect (div $imagewidth $aspect) (int (mul $imagewidth (div $imagewidth $aspect))) $imagemargincss */}}
  
  {{- $defaultimage := index $imagelist 0 -}}{{/* Just use the first, i.e. largest */}}

  {{- $lightboxstring := "" -}}
  {{- if $gallery -}}
    {{- $lightboxstring = printf "data-lightbox='%s'" $gallery -}}
  {{- else if $lightbox -}}
    {{/* FIXME passing RelPermalink as the gallery name seems a bit weird, but how else to make it unique? */}}
    {{- $lightboxstring = printf "data-lightbox='%s'" $defaultimage.RelPermalink -}}
  {{- end -}}
  {{/* warnf "fs: lbstring=%s  gallery=%s\n" $lightboxstring $gallery */}}

  {{/* height, if any, is set via figrow shortcode (parent) */}}
  {{/* figure needs to be same width as img, otherwise it's too wide to allow any text flow */}}
  {{- $figcss := "" -}}{{/* CSS for figure, or its enclosing 'a' FIXME rename it */}}
  {{- $figclass := "" -}}{{/* classes for figure, or its enclosing 'a' FIXME rename it */}}
  {{- $imgcss := "" -}}
  {{- if .height -}}
    {{/* $figcss = (printf "margin: 0; width: %q;" $imagewidthstring) */}}{{/* FIXME but if .height specified, we're not using $imagewidth -- need to use ... */}}
    {{/* FIXME probably not needed because it's already the exact size we want  $imgcss = (printf "height: %s;" .height) */}}
  {{- else -}}
    {{/* $figcss = (printf "margin: 0; flex: 0 0 auto; %s" $imagewidthstring) NO!! no flex in the figure */}}
    {{- $figcss = (printf "margin: 0; %s" $imagewidthstring) -}}
    {{- $figclass = "mx-2" -}}
  {{- end -}}
  {{/* warnf "fs figcss=%s  figclass=%s  imgcss=%s  \n" $figcss $figclass $imgcss */}}

  {{- $link := true -}}
  {{- $dataurlstring := "" -}}
  {{- if $lightboxstring -}}
    {{/* warnf "lbs is not empty..." */}}
    {{/* TODO maybe -- let the JS extract the image url/name from the fig */}}
    {{- $lightboxstring = printf "%s data-image='%s'" $lightboxstring $defaultimage.RelPermalink -}}

    {{/* warnf "adding to lbs: url=%s alt=%s title=%s" $url $alt $title */}}
    {{- with $url -}}{{- $lightboxstring = printf "%s data-url='%s'" $lightboxstring . -}}{{- end -}}
    {{- with $alt -}}{{- $lightboxstring = printf "%s data-alt='%s'" $lightboxstring . -}}{{- end -}}
    {{/* use caption as default title just for the lightbox */}}
    {{- with ($title | default $caption) }}{{ $lightboxstring = printf "%s data-title='%s'" $lightboxstring . }}{{ end -}}

    {{/* Create srcset entries as a dict */}}
    {{- $srcset := slice -}}
    {{- range $i := $imagelist -}}
      {{- $srcset = $srcset | append (dict "url" $i.RelPermalink "width" $i.Width "height" $i.Height) -}}
    {{- end -}}

    {{/* Use default image for href in case the clever JS doesn't work */}}
    {{/* NOTE either data-remote or href gets used for the image to display */}}
    {{- $figcss = "margin: 0; " -}}
    {{- $figclass = "" -}}
  {{- else if $url -}}{{/* Link but no lightbox -- wrap with <a> */}}
    {{/* warnf "simple link" */}}
    <a href="{{ $url }}" class="{{ $figclass }}" style="display: block; {{ $figcss | safeCSS }}">
    {{- $figcss = "" -}}
    {{- $figclass = "" -}}
  {{- else -}}
    {{/* warnf "no link" */}}
    {{- $link = false -}}
  {{- end -}}

  {{ $figcss = printf "%s; display: table;" $figcss }}
  {{ $imgcss = printf "%s; display: table-cell;" $figcss }}
  {{ $capcss := "display: table-caption; caption-side: bottom;" }}

  {{/* warnf "figclass='%s' posclass='%s' lightboxstring='%s'" $figclass $posclass $lightboxstring */}}
  <figure class="xfigure figset {{ $figclass }} {{ $posclass }}" {{ $lightboxstring | safeHTMLAttr}} {{ with $figcss }}style="{{ . | safeCSS }}"{{ end }}>
  <img loading=lazy class="ximg-fluid xxmx-2 xborder xborder-primary"
    {{/* Only include srcset if there is more than one */}}
    {{- if gt (len $imagelist) 1 -}}
      srcset="
      {{- range $i := $imagelist -}}
        {{- $i.RelPermalink }} {{ printf "%dw" $i.Width -}},
      {{- end -}}
      "
    {{- end -}}
    {{- with $sizeString }} sizes="{{ $sizeString }}"{{- end -}}
    src="{{ $defaultimage.RelPermalink }}" 
    {{/* This doesnt work -- images get too big: width="{{ $defaultimage.Width }}" height="{{ $defaultimage.Height }}"  { { /* see https://chipcullen.com/what-width-and-height-attributes-to-use-with-responsive-images/ */}}
    {{- with $alt }} alt="{{- . | safeHTMLAttr -}}" {{- end -}}
    {{- with $title }} title="{{- . | safeHTMLAttr -}}" {{- end -}}
    style="{{ $imgcss | safeCSS }} {{ $imagemargincss | safeCSS }}" {{/* 100% of figure                   .already done with img-fluid: max-width: 100%; height: auto; */}}
    {{/* object-fit: contain; ??? */}}
  >
  {{- if $caption -}}
  <figcaption xclass=figure-caption style="{{ $capcss | safeCSS }}">{{ $caption | safeHTMLAttr }}</figcaption>
  {{- end -}}
  </figure>
  {{- if $link -}}
    </a>
  {{- end -}}

{{- else -}}
[image '{{ $name }}' not found]
{{- end -}}
